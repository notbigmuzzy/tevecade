<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tevecade - TV Local</title>

  <!-- IMPORT -->
  <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
  <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
  
  <!-- STYLE -->
  <style>
    control-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 10px;
      display: none;
      justify-content: space-between;
      align-items: center;
      pointer-events: none;
      height: 50px;
      width: 100%;
      box-sizing: border-box;
      background: rgba(0, 0, 0, .5);
    }
    .tv-watcher-container.controls-visible control-bar {
      display: flex;
    }
    control-bar button {
      pointer-events: initial;
      z-index: 10;
      font-size: 1em;
      border-radius: 5px;
      border: none;
      background: transparent;
      color: #fff;
      cursor: pointer;
      padding: 0;
      width: 50px;
      height: 50px;
    }
    control-bar .titlebar-station-name {
      color: #fff;
      font-size: 1.2em;
      font-weight: bold;
      flex-grow: 1;
      text-align: center;
      pointer-events: initial;
    }
    .vjs-error .vjs-error-display .vjs-modal-dialog-content {
      display: flex;
      align-items: end;
      justify-content: center;
    }
    .input-wrapper {
      display: flex;
      width: 100%;
      height: 40px;
      position: relative;
      width: 100%;

      & > div {
        flex: 1;
        flex-basis: 50%;
      }
    }
    .input-wrapper .select-url select{
      width: 100%;
      height: 100%;
      border: none;
      outline: none;
      padding: 10px;
    }
    .input-wrapper input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
    }
    .clear-btn {
      position: absolute;
      right: 0.3em;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      font-size: 1.2em;
      color: #888;
      cursor: pointer;
      padding: 0 0.3em;
      line-height: 1;
      display: none;
    }
    .input-wrapper input[type="text"]:not(:placeholder-shown) + .clear-btn {
      display: inline;
    }
    .error-getting-stations {
      color: #929292;
      font-weight: bold;
      text-align: center;
      padding: 1rem;
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      margin: 0 auto;
    }
    .station-logo {
      width: 32px;
      height: 32px;
      object-fit: contain;
      vertical-align: middle;
      margin-right: 8px;
    }
    .station-number {
      position: absolute;
      right: 16px;
      top: 8px;
      margin-left: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #eee;
      color: #222;
      font-weight: bold;
      font-size: 1em;
      border: 1px solid #ccc;
      text-align: center;
    }
    html, body, div, span, applet, object, iframe,
    h1, h2, h3, h4, h5, h6, p, blockquote, pre,
    a, abbr, acronym, address, big, cite, code,
    del, dfn, em, img, ins, kbd, q, s, samp,
    small, strike, strong, sub, sup, tt, var,
    b, u, i, center,
    dl, dt, dd, ol, ul, li,
    fieldset, form, label, legend,
    table, caption, tbody, tfoot, thead, tr, th, td,
    article, aside, canvas, details, embed, 
    figure, figcaption, footer, header, hgroup, 
    menu, nav, output, ruby, section, summary,
    time, mark, audio, video {
      margin: 0;
      padding: 0;
      border: 0;
      font-size: 100%;
      font: inherit;
      vertical-align: baseline;
    }
    article, aside, details, figcaption, figure, 
    footer, header, hgroup, menu, nav, section {
      display: block;
    }
    body {
      line-height: 1;
    }
    ol, ul {
      list-style: none;
    }
    blockquote, q {
      quotes: none;
    }
    blockquote:before, blockquote:after,
    q:before, q:after {
      content: '';
      content: none;
    }
    table {
      border-collapse: collapse;
      border-spacing: 0;
    }
    html, body {
      height: 100%;
    }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      background: #f4f4f4;
      color: #222;
    }
    header {
      background: #222;
      color: #fff;
      padding: 1rem 0;
      text-align: center;
    }
    main {
      display: flex;
      flex-direction: row;
      background: #ccc;
      height: 100%;
      overflow: hidden;
    }
    station-picker {
      position: relative;
      width: 280px;
      height: 100%;
    }
    station-picker input {
      width: 100%;
      height: 40px;
      padding: 0 10px;
      box-sizing: border-box;
      border: none;
    }
    station-picker input:focus {
      outline: none;
      border: none;
    }
    station-picker ul {
      height: calc(100% - 40px);
      overflow-y: auto;
      overflow-x: hidden;
      padding: 0;
      margin: 0;
      list-style: none;
    }
    station-picker a {
      position: relative;
      display: flex;
      align-items: center;
      padding: 8px 50px 8px 16px;
      text-decoration: none;
      color: #222;
      border-bottom: 1px solid #eee;
      overflow: hidden;
    }
    station-picker a span {
      display: block;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      min-width: 0;
      max-width: 100%;
      flex: 1 1 auto;
    }
    station-picker a:hover {
      background-color: rgb(180, 0, 0);
      color: #fff;
      font-weight: bold;
    }
    .tv-watcher-container {
      width: calc(100% - 280px);
      height: 100%;
      position: relative;
      background-color: #222;
    }
    .tv-watcher-container.maximized {
      width: 100vw;
      z-index: 20;
    }
    .sidebar-hidden station-picker {
      display: none;
    }
    tv-watcher {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #222;
    }
    tv-watcher .video-js {
      width: 100% !important;
      height: 100% !important;
    }
  </style>
</head>
<body>

  <!-- TEMPLATE -->
  <main>
    <station-picker>
      <div class="input-wrapper">
        <div class="select-url">
          <select>
            <option value="" disabled selected>Select a station</option>
            <option value="https://notbigmuzzy.github.io/tevecade/urls/balkan.m3u">TV</option>
            <option value="https://notbigmuzzy.github.io/tevecade/urls/films.m3u">Filmovi</option>
            <option value="https://notbigmuzzy.github.io/tevecade/urls/sport.m3u">Sport</option>
            <option value="https://notbigmuzzy.github.io/tevecade/urls/music.m3u">Music</option>
          </select>
        </div>
        <div class="search-channel">
          <input type="text" placeholder="Search ...">
          <button type="button" class="clear-btn" title="Limpiar">×</button>
        </div>
      </div>
      <ul>
        <li></li>
      </ul>
    </station-picker>
    <div class="tv-watcher-container">
      <tv-watcher>
        <video-player></video-player>
      </tv-watcher>
      <control-bar>
        <button id="hide-sidebar-btn">←</button>
        <span class="titlebar-station-name">Select a station</span>
        <button id="fullscreen-btn">⛶</button>
      </control-bar>
    </div>
  </main>

  <!-- LOGIC -->
  <script>
    function getSelectedUrl() {
      const select = document.querySelector('.select-url select');
      return select ? select.value : '';
    }
    let FREETVM3U8URL = getSelectedUrl();

    function requestFullscreen(elem) {
      if (elem.requestFullscreen) {
        elem.requestFullscreen();
      } else if (elem.webkitRequestFullscreen) {
        elem.webkitRequestFullscreen();
      } else if (elem.msRequestFullscreen) {
        elem.msRequestFullscreen();
      }
    }

    async function loadStations(url) {
      const ul = document.querySelector('station-picker ul');
      ul.innerHTML = '<li class="error-getting-stations">No stations selected</li>';
      try {
        const res = await fetch(url);
        const text = await res.text();
        const lines = text.split('\n');
        let stations = [];
        for (let i = 0; i < lines.length; i++) {
          if (lines[i].startsWith('#EXTINF')) {
            let name = 'Canal';
            let logo = '';
            const extinf = lines[i];
            let match = extinf.match(/tvg-id="([^"]+)"/);
            if (match && match[1]) {
              name = match[1].trim();
            } else {
              match = extinf.match(/tvg-name="([^"]+)"/);
              if (match && match[1]) {
                name = match[1].trim();
              } else {
                match = extinf.match(/group-title="([^"]+)"/);
                if (match && match[1]) {
                  name = match[1].trim();
                } else {
                  match = extinf.match(/,(.*)$/);
                  if (match && match[1]) {
                    name = match[1].trim();
                  }
                }
              }
            }
            match = extinf.match(/tvg-logo="([^"]+)"/);
            if (match && match[1]) {
              logo = match[1].trim();
            }
            const url = lines[i+1] && !lines[i+1].startsWith('#') ? lines[i+1].trim() : '';
            if (url) stations.push({ name, url, logo });
          }
        }
        const filteredStations = stations.filter(station => station.url.endsWith('.m3u8'));
        ul.innerHTML = '';
        filteredStations.forEach((station, idx) => {
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.href = '#';
          if (station.logo) {
            const img = document.createElement('img');
            img.src = station.logo;
            img.alt = station.name + ' logo';
            img.className = 'station-logo';
            a.appendChild(img);
          }
          const span = document.createElement('span');
          span.textContent = station.name;
          a.appendChild(span);
          const number = document.createElement('span');
          number.className = 'station-number';
          number.textContent = idx + 1;
          a.appendChild(number);
          a.addEventListener('click', (e) => {
            e.preventDefault();
            
            // Update the titlebar station name
            const titlebarStationName = document.querySelector('.titlebar-station-name');
            if (titlebarStationName) {
              titlebarStationName.textContent = station.name;
            }
            
            const tvWatcher = document.querySelector('tv-watcher');
            tvWatcher.innerHTML = '';
            const video = document.createElement('video');
            video.setAttribute('controls', 'false');
            video.setAttribute('autoplay', '');
            video.setAttribute('width', '640');
            video.setAttribute('height', '360');
            video.setAttribute('playsinline', '');
            video.style.background = '#000';
            tvWatcher.appendChild(video);
            video.className = 'video-js vjs-default-skin';
            video.setAttribute('data-setup', '{"nativeControlsForTouch":true}');
            const source = document.createElement('source');
            source.src = station.url;
            source.type = 'application/x-mpegURL';
            video.appendChild(source);
            if (window.videojs) {
              const player = window.videojs(video, {
                controls: false,
                nativeControlsForTouch: false,
                fluid: false,
                responsive: false
              });
              
              // Force native controls by hiding Video.js controls
              player.ready(() => {
                player.controls(false);
                video.controls = false;
              });
            }
          });
          li.appendChild(a);
          li.dataset.url = station.url;
          ul.appendChild(li);
        });
        const filterInput = document.querySelector('station-picker input[type="text"]');
        const clearBtn = document.querySelector('.clear-btn');
        function filterList() {
          const filter = filterInput.value.trim().toLowerCase();
          const items = ul.querySelectorAll('li');
          items.forEach(li => {
            const name = li.textContent.trim().toLowerCase();
            if (name.includes(filter)) {
              li.style.display = '';
            } else {
              li.style.display = 'none';
            }
          });
          clearBtn.style.display = filter ? 'inline' : 'none';
        }
        filterInput.addEventListener('input', filterList);
        clearBtn.addEventListener('click', function() {
          filterInput.value = '';
          filterInput.focus();
          filterList();
        });
        clearBtn.style.display = 'none';
      } catch (e) {
        ul.innerHTML = '<li class="error-getting-stations">No stations selected</li>';
      }
    }

    window.addEventListener('DOMContentLoaded', async () => {
      document.getElementById('fullscreen-btn').addEventListener('click', function() {
        requestFullscreen(document.querySelector('main'));
      });
      const select = document.querySelector('.select-url select');
      select.addEventListener('change', function() {
        FREETVM3U8URL = select.value;
        loadStations(FREETVM3U8URL);
      });
      FREETVM3U8URL = getSelectedUrl();
      loadStations(FREETVM3U8URL);

      // Hide sidebar logic
      const hideSidebarBtn = document.getElementById('hide-sidebar-btn');
      const main = document.querySelector('main');
      const tvWatcherContainer = document.querySelector('.tv-watcher-container');
      hideSidebarBtn.addEventListener('click', function() {
        main.classList.toggle('sidebar-hidden');
        tvWatcherContainer.classList.toggle('maximized');
      });

      // Show control-bar only when video.js controls are visible
      function setupVideoJsControlBarSync() {
        const tvWatcher = document.querySelector('tv-watcher');
        const container = document.querySelector('.tv-watcher-container');
        const observer = new MutationObserver(() => {
          const video = tvWatcher.querySelector('video');
          if (!video || !window.videojs) return;
          const vjs = window.videojs.getPlayer ? window.videojs.getPlayer(video) : window.videojs(video);
          if (!vjs) return;
          vjs.ready(function() {
            vjs.on('userinactive', function() {
              container.classList.remove('controls-visible');
            });
            vjs.on('useractive', function() {
              container.classList.add('controls-visible');
            });
            // Initial state
            if (vjs.userActive()) {
              container.classList.add('controls-visible');
            } else {
              container.classList.remove('controls-visible');
            }
          });
        });
        observer.observe(tvWatcher, { childList: true, subtree: true });
      }
      setupVideoJsControlBarSync();
    });
  </script>
</body>
</html>
